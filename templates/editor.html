{% extends "base.html" %}

{% block content %}
<!-- Quill CSS -->
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">

<div class="row mb-4">
    <div class="col-12 d-flex justify-content-between align-items-center">
        <h2>{{ 'Editar' if mode == 'edit' else 'Nova' }} Avaliação</h2>
        <div>
            <button onclick="saveAssessment()" class="btn btn-primary">
                <i class="fas fa-save me-2"></i>Salvar
            </button>
            <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">Cancelar</a>
        </div>
    </div>
</div>

<div class="row">
    <!-- Settings Sidebar -->
    <div class="col-md-3">
        <div class="card mb-3">
            <div class="card-header bg-light">Configurações</div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">Título</label>
                    <input type="text" class="form-control" id="examTitle" value="{{ assessment.title }}">
                </div>
                <div class="mb-3">
                    <label class="form-label">Turma</label>
                    <input type="text" class="form-control" id="examClass" value="{{ assessment.class_name }}">
                </div>
                <div class="mb-3">
                    <label class="form-label">Data</label>
                    <input type="text" class="form-control" id="examDate" value="{{ assessment.date }}">
                </div>
                <div class="mb-3">
                    <label class="form-label">Logo da Escola</label>
                    <input type="file" class="form-control" id="examLogoFile" accept="image/*">
                    <input type="hidden" id="examLogo" value="{{ assessment.school_logo }}">
                    <div class="mt-2">
                        <img id="logoPreview" src="{{ assessment.school_logo }}"
                            style="max-height: 100px; display: {{ 'block' if assessment.school_logo else 'none' }};">
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Fonte</label>
                    <select class="form-select" id="examFont">
                        <option value="Arial" {{ 'selected' if assessment.settings.font=='Arial' }}>Arial</option>
                        <option value="Times New Roman" {{ 'selected' if assessment.settings.font=='Times New Roman' }}>
                            Times New Roman</option>
                        <option value="Helvetica" {{ 'selected' if assessment.settings.font=='Helvetica' }}>Helvetica
                        </option>
                        <option value="OpenDyslexic" {{ 'selected' if assessment.settings.font=='OpenDyslexic' }}>
                            Dislexia (OpenDyslexic)</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Colunas</label>
                    <select class="form-select" id="examColumns">
                        <option value="1" {{ 'selected' if assessment.settings.columns==1 }}>1 Coluna</option>
                        <option value="2" {{ 'selected' if assessment.settings.columns==2 }}>2 Colunas</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header bg-light">Redação</div>
            <div class="card-body">
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" id="essayEnabled" {{ 'checked' if
                        assessment.essay.enabled }}>
                    <label class="form-check-label" for="essayEnabled">Incluir Redação</label>
                </div>
                <div id="essayFields" style="display: {{ 'block' if assessment.essay.enabled else 'none' }}">
                    <div class="mb-3">
                        <label class="form-label">Tema</label>
                        <input type="text" class="form-control" id="essayTheme" value="{{ assessment.essay.theme }}">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Textos Motivadores (separe por linha em branco)</label>
                        <textarea class="form-control" id="essayTexts"
                            rows="4">{{ assessment.essay.texts | join('\n\n') }}</textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Instruções</label>
                        <textarea class="form-control" id="essayInstructions"
                            rows="3">{{ assessment.essay.instructions }}</textarea>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Questions Area -->
    <div class="col-md-9">
        <div class="card mb-3">
            <div class="card-header bg-light">Instruções Gerais</div>
            <div class="card-body">
                <textarea class="form-control" id="examInstructions" rows="3">{{ assessment.instructions }}</textarea>
            </div>
        </div>

        <div id="questionsContainer">
            <!-- Questions will be rendered here by JS -->
        </div>

        <div class="d-grid gap-2 mb-5">
            <div class="btn-group">
                <button onclick="addQuestion('multiple_choice')" class="btn btn-outline-primary">
                    <i class="fas fa-list-ul me-2"></i>Múltipla Escolha
                </button>
                <button onclick="addQuestion('true_false')" class="btn btn-outline-primary">
                    <i class="fas fa-check-square me-2"></i>Certo/Errado
                </button>
                <button onclick="addQuestion('discursive')" class="btn btn-outline-primary">
                    <i class="fas fa-align-left me-2"></i>Discursiva
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Hidden input to store initial questions data for JS -->
<input type="hidden" id="initialQuestions" value='{{ assessment.questions | tojson | safe }}'>
<input type="hidden" id="assessmentId" value="{{ assessment.id }}">

<!-- Quill JS -->
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

<script>
    // Pass assessment ID to external JS
    const ASSESSMENT_ID = "{{ assessment.id }}";
</script>
{% endblock %}